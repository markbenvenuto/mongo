# -*- mode: python; -*-
Import("env")

env = env.Clone()

if env.ToolchainIs('clang', 'GCC'):
    env.Append(CCFLAGS=['-Wno-unused-variable'])

# How to import
# Source Location:
# https://github.com/jedisct1/libsodium.git
# https://download.libsodium.org/libsodium/releases/libsodium-1.0.4.tar.gz
#
# LibSodium does not generate a config.h header file. It instead uses a list of defines appended to
# the compiler command line. To get this list, follow the directions below
# 1. Run configure for each platform
# 2. grep DEFS Makefile | sed "s/-D/~/g" | tr "~" "\n" | grep -v "DEFS =" | grep "=1" | sort | sed "s/\(.*\)=1/'\1', /"
# 3. Wrap uneeded code in utils.c with #if 0 to minimize libsodium import

# Linux Defines - RHEL 5.5
# DEFS = -DPACKAGE_NAME=\"libsodium\" -DPACKAGE_TARNAME=\"libsodium\" -DPACKAGE_VERSION=\"1.0.4\" -DPACKAGE_STRING=\"libsodium\ 1.0.4\" -DPACKAGE_BUGREPORT=\"https://github.com/jedisct1/libsodium/issues\" -DPACKAGE_URL=\"https://github.com/jedisct1/libsodium\" -DPACKAGE=\"libsodium\" -DVERSION=\"1.0.4\" -DSTDC_HEADERS=1 -DHAVE_SYS_TYPES_H=1 -DHAVE_SYS_STAT_H=1 -DHAVE_STDLIB_H=1 -DHAVE_STRING_H=1 -DHAVE_MEMORY_H=1 -DHAVE_STRINGS_H=1 -DHAVE_INTTYPES_H=1 -DHAVE_STDINT_H=1 -DHAVE_UNISTD_H=1 -D__EXTENSIONS__=1 -D_ALL_SOURCE=1 -D_GNU_SOURCE=1 -D_POSIX_PTHREAD_SEMANTICS=1 -D_TANDEM_SOURCE=1 -DHAVE_DLFCN_H=1 -DLT_OBJDIR=\".libs/\" -DHAVE_MMINTRIN_H=1 -DHAVE_EMMINTRIN_H=1 -DHAVE_PMMINTRIN_H=1 -DHAVE_TMMINTRIN_H=1 -DHAVE_SYS_MMAN_H=1 -DNATIVE_LITTLE_ENDIAN=1 -DHAVE_AMD64_ASM=1 -DHAVE_TI_MODE=1 -DHAVE_CPUID=1 -DHAVE_WEAK_SYMBOLS=1 -DHAVE_MMAP=1 -DHAVE_MLOCK=1 -DHAVE_MADVISE=1 -DHAVE_MPROTECT=1 -DHAVE_POSIX_MEMALIGN=1 -DHAVE_GETPID=1

# Solaris Defines - Illumos - OmniIT
# DEFS = -DPACKAGE_NAME=\"libsodium\" -DPACKAGE_TARNAME=\"libsodium\" -DPACKAGE_VERSION=\"1.0.4\" -DPACKAGE_STRING=\"libsodium\ 1.0.4\" -DPACKAGE_BUGREPORT=\"https://github.com/jedisct1/libsodium/issues\" -DPACKAGE_URL=\"https://github.com/jedisct1/libsodium\" -DPACKAGE=\"libsodium\" -DVERSION=\"1.0.4\" -DSTDC_HEADERS=1 -DHAVE_SYS_TYPES_H=1 -DHAVE_SYS_STAT_H=1 -DHAVE_STDLIB_H=1 -DHAVE_STRING_H=1 -DHAVE_MEMORY_H=1 -DHAVE_STRINGS_H=1 -DHAVE_INTTYPES_H=1 -DHAVE_STDINT_H=1 -DHAVE_UNISTD_H=1 -D__EXTENSIONS__=1 -D_ALL_SOURCE=1 -D_GNU_SOURCE=1 -D_POSIX_PTHREAD_SEMANTICS=1 -D_TANDEM_SOURCE=1 -DHAVE_DLFCN_H=1 -DLT_OBJDIR=\".libs/\" -DHAVE_MMINTRIN_H=1 -DHAVE_EMMINTRIN_H=1 -DHAVE_PMMINTRIN_H=1 -DHAVE_TMMINTRIN_H=1 -DHAVE_SMMINTRIN_H=1 -DHAVE_WMMINTRIN_H=1 -DHAVE_SYS_MMAN_H=1 -DNATIVE_LITTLE_ENDIAN=1 -DHAVE_CPUID=1 -DHAVE_WEAK_SYMBOLS=1 -DHAVE_MMAP=1 -DHAVE_MLOCK=1 -DHAVE_MADVISE=1 -DHAVE_MPROTECT=1 -DHAVE_POSIX_MEMALIGN=1 -DHAVE_GETPID=1

# MacOS X Defines - 10.9
# DEFS = -DPACKAGE_NAME=\"libsodium\" -DPACKAGE_TARNAME=\"libsodium\" -DPACKAGE_VERSION=\"1.0.4\" -DPACKAGE_STRING=\"libsodium\ 1.0.4\" -DPACKAGE_BUGREPORT=\"https://github.com/jedisct1/libsodium/issues\" -DPACKAGE_URL=\"https://github.com/jedisct1/libsodium\" -DPACKAGE=\"libsodium\" -DVERSION=\"1.0.4\" -DSTDC_HEADERS=1 -DHAVE_SYS_TYPES_H=1 -DHAVE_SYS_STAT_H=1 -DHAVE_STDLIB_H=1 -DHAVE_STRING_H=1 -DHAVE_MEMORY_H=1 -DHAVE_STRINGS_H=1 -DHAVE_INTTYPES_H=1 -DHAVE_STDINT_H=1 -DHAVE_UNISTD_H=1 -D__EXTENSIONS__=1 -D_ALL_SOURCE=1 -D_GNU_SOURCE=1 -D_POSIX_PTHREAD_SEMANTICS=1 -D_TANDEM_SOURCE=1 -DHAVE_DLFCN_H=1 -DLT_OBJDIR=\".libs/\" -DHAVE_MMINTRIN_H=1 -DHAVE_EMMINTRIN_H=1 -DHAVE_PMMINTRIN_H=1 -DHAVE_TMMINTRIN_H=1 -DHAVE_SMMINTRIN_H=1 -DHAVE_WMMINTRIN_H=1 -DHAVE_SYS_MMAN_H=1 -DNATIVE_LITTLE_ENDIAN=1 -DHAVE_AMD64_ASM=1 -DHAVE_TI_MODE=1 -DHAVE_CPUID=1 -DHAVE_WEAK_SYMBOLS=1 -DHAVE_ARC4RANDOM=1 -DHAVE_ARC4RANDOM_BUF=1 -DHAVE_MMAP=1 -DHAVE_MLOCK=1 -DHAVE_MADVISE=1 -DHAVE_MPROTECT=1 -DHAVE_POSIX_MEMALIGN=1 -DHAVE_GETPID=1

if not env.TargetOSIs('windows'):
    env.Append(CPPDEFINES=[
            'HAVE_CPUID',
            'HAVE_DLFCN_H',
            'HAVE_EMMINTRIN_H',
            'HAVE_GETPID',
            'HAVE_INTTYPES_H',
            'HAVE_MADVISE',
            'HAVE_MEMORY_H',
            'HAVE_MLOCK',
            'HAVE_MMAP',
            'HAVE_MMINTRIN_H',
            'HAVE_MPROTECT',
            'HAVE_PMMINTRIN_H',
            'HAVE_POSIX_MEMALIGN',
            'HAVE_STDINT_H',
            'HAVE_STDLIB_H',
            'HAVE_STRINGS_H',
            'HAVE_STRING_H',
            'HAVE_SYS_MMAN_H',
            'HAVE_SYS_STAT_H',
            'HAVE_SYS_TYPES_H',
            'HAVE_TMMINTRIN_H',
            'HAVE_UNISTD_H',
            'HAVE_WEAK_SYMBOLS',
            'NATIVE_LITTLE_ENDIAN',
            'STDC_HEADERS',
            '_ALL_SOURCE',
            '_GNU_SOURCE',
            '_POSIX_PTHREAD_SEMANTICS',
            '_TANDEM_SOURCE',
            '__EXTENSIONS__',
            ])

env.Append(CPPPATH="src/libsodium/include/sodium")
env.Library(
    target="libsodium",
    source=[
        'src/libsodium/sodium/utils.c',
    ])

